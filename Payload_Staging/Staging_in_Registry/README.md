# About 

This features staging/storing the payload/shellcode as a registry value in the windows registry files and then retrieving it in runtime from the malware/binary, rather than storing the payload in the binary. 

This is highly useful as well, because the content in the registry stay unaffected to system reboots, unlike other methods.

This reduces the chances of being detected and completely avoids static analysis and other forms of static detection methods and tools. This is highly effective when encrypted and stored in the registry. However, my implementation just features a direct unencrypted retrieval and storing, to just show how the technique works.


# Technique

`REGISTRY` corresponds to the registry key that would hold the payload.
`REGSTRING` corresponds to the name of the value inside the registry key.


## Writing to the Registry

Windows OS actually has APis that allow programs to interact with the registry. For writing the APIs that we are going to be using are, 

- [RegOpenKeyExA]() is used to open a handle to an opened key. 
- [RegSetValueExA]() allows us to set or delete a value to the opened key.

## Reading from the Registry

To just read the value from the registry, it only requires a single API, which is defined under the `Advapi32.lib`. This needs to be included explicitly while compiing as such,

```c++
#pragma comment (lib, "Advapi32.lib")
```
 API - 

- [RegGetValueA]() is used to read from any given registry value and store it in a buffer that we provide

**NOTE** : The number of bytes that you wish to read must be the same as the number of bytes of the value that you are trying to read. Anything higher or lesser, would end in an error being thrown, regardless of the buffer being initialised for more number of bytes.


These steps cover the registry storing and retrieval aspect of the malware. Now we, can just go about the normal routine of copying this shellcode to a new memory space, making it executable and then executing it.

For more information on how to do this, checkout this [repo](https://github.com/retr0ds/Malware-learning/tree/main/Shellcode-Injection).